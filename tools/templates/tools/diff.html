{% extends 'tools/base.html' %}
{% load i18n %}
{% block title %}{% trans "文本对比" %}{% endblock %}
{% block content %}
<div class="card p-4 mb-4">
  <h2 class="mb-3"><i class="bi bi-file-diff"></i> {% trans "文本对比" %}</h2>
  <form id="diffForm" method="post">
    {% csrf_token %}
    <div class="row mb-3 g-2 align-items-end">
      <div class="col-12 col-md-6 position-relative">
        <label class="form-label">{% trans "文本1" %}</label>
        <div class="diff-input-wrap">
          <div class="diff-linenum" id="linenum1"></div>
          <textarea class="form-control diff-input" name="text1" rows="10" id="text1">{{ text1|default:'' }}</textarea>
        </div>
      </div>
      <div class="col-12 col-md-6 position-relative">
        <label class="form-label">{% trans "文本2" %}</label>
        <div class="diff-input-wrap">
          <div class="diff-linenum" id="linenum2"></div>
          <textarea class="form-control diff-input" name="text2" rows="10" id="text2">{{ text2|default:'' }}</textarea>
        </div>
      </div>
    </div>
    <button type="submit" class="btn btn-primary"><i class="bi bi-arrow-left-right"></i> {% trans "对比" %}</button>
  </form>
  <div id="diffResultWrap">
    {% if diff %}
    <hr>
    <div class="alert alert-info">
      <h6>{% trans "对比结果：" %}</h6>
      <div class="row g-0" id="diffAreaWrap">
        <div class="col-6 border-end position-relative"><div class="diff-linenum-result" id="resultLinenum1"></div><pre id="diffArea1" class="diff-pre"></pre></div>
        <div class="col-6 position-relative"><div class="diff-linenum-result" id="resultLinenum2"></div><pre id="diffArea2" class="diff-pre"></pre></div>
      </div>
      <button class="btn btn-outline-secondary btn-sm mt-2" onclick="copyDiff()"><i class="bi bi-clipboard"></i> {% trans "复制" %}</button>
    </div>
    {% endif %}
  </div>
<style>
.diff-input-wrap { display: flex; }
.diff-linenum {
  min-width: 2.2em;
  background: #f4f4f4;
  color: #888;
  text-align: right;
  padding: 8px 4px 8px 0;
  font-size: 0.95em;
  user-select: none;
  border-right: 1px solid #eee;
}
.diff-input { resize: vertical; }
.diff-linenum-result {
  position: absolute;
  left: 0; top: 0; bottom: 0;
  width: 2.2em;
  background: #f4f4f4;
  color: #888;
  text-align: right;
  padding: 8px 4px 8px 0;
  font-size: 0.95em;
  user-select: none;
  border-right: 1px solid #eee;
  z-index: 2;
}
.diff-pre { min-height: 200px; max-height: 400px; overflow: auto; background: #f8f9fa; margin-left: 2.2em; }
.diff-line-del { background: #ffeaea; color: #c00; }
.diff-line-add { background: #eaffea; color: #080; }
.diff-line-same { background: #fff; color: #333; }
</style>
<!-- Toast -->
<div class="position-fixed top-0 end-0 p-3" style="z-index: 1080">
  <div id="diffToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
    <div class="d-flex">
      <div class="toast-body">
        <i class="bi bi-clipboard-check"></i> {% trans "复制成功！" %}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
    </div>
  </div>
</div>
<script>
function copyDiff() {
  var text1 = document.getElementById('diffArea1').innerText;
  var text2 = document.getElementById('diffArea2').innerText;
  navigator.clipboard.writeText(text1 + '\n---\n' + text2).then(function(){
    var toast = new bootstrap.Toast(document.getElementById('diffToast'));
    toast.show();
  });
}

// 输入区行号渲染
function updateInputLinenum(textareaId, linenumId) {
  const ta = document.getElementById(textareaId);
  const ln = document.getElementById(linenumId);
  function render() {
    const lines = ta.value.split('\n').length;
    ln.innerHTML = Array.from({length: lines}, (_,i)=>i+1).join('<br>');
  }
  ta.addEventListener('input', render);
  render();
}
updateInputLinenum('text1', 'linenum1');
updateInputLinenum('text2', 'linenum2');
// 结果区行号渲染
function renderResultLinenum(lines, id) {
  document.getElementById(id).innerHTML = Array.from({length: lines}, (_,i)=>i+1).join('<br>');
}

function renderSideBySideDiff(text1, text2) {
  // 简单逐行对比，compare beyond风格
  const a = text1.split('\n');
  const b = text2.split('\n');
  const max = Math.max(a.length, b.length);
  let html1 = '', html2 = '';
  for (let i = 0; i < max; i++) {
    const l1 = a[i] !== undefined ? a[i] : '';
    const l2 = b[i] !== undefined ? b[i] : '';
    if (l1 === l2) {
      html1 += `<div class='diff-line-same'>${l1.replace(/ /g,'&nbsp;')}</div>`;
      html2 += `<div class='diff-line-same'>${l2.replace(/ /g,'&nbsp;')}</div>`;
    } else if (l1 && !l2) {
      html1 += `<div class='diff-line-del'>${l1.replace(/ /g,'&nbsp;')}</div>`;
      html2 += `<div class='diff-line-del'>&nbsp;</div>`;
    } else if (!l1 && l2) {
      html1 += `<div class='diff-line-add'>&nbsp;</div>`;
      html2 += `<div class='diff-line-add'>${l2.replace(/ /g,'&nbsp;')}</div>`;
    } else {
      html1 += `<div class='diff-line-del'>${l1.replace(/ /g,'&nbsp;')}</div>`;
      html2 += `<div class='diff-line-add'>${l2.replace(/ /g,'&nbsp;')}</div>`;
    }
  }
  document.getElementById('diffArea1').innerHTML = html1;
  document.getElementById('diffArea2').innerHTML = html2;
  renderResultLinenum(max, 'resultLinenum1');
  renderResultLinenum(max, 'resultLinenum2');
}

const diffForm = document.getElementById('diffForm');
diffForm.addEventListener('submit', function(e) {
  e.preventDefault();
  const formData = new FormData(diffForm);
  fetch('', {
    method: 'POST',
    headers: { 'X-Requested-With': 'XMLHttpRequest' },
    body: formData
  })
  .then(res => res.json())
  .then(data => {
    let html = '<hr><div class="alert alert-info">';
    html += '<h6>{% trans "对比结果：" %}</h6>';
    html += '<div class="row g-0" id="diffAreaWrap">';
    html += '<div class="col-6 border-end position-relative"><div class="diff-linenum-result" id="resultLinenum1"></div><pre id="diffArea1" class="diff-pre"></pre></div>';
    html += '<div class="col-6 position-relative"><div class="diff-linenum-result" id="resultLinenum2"></div><pre id="diffArea2" class="diff-pre"></pre></div>';
    html += '</div>';
    html += '<button class="btn btn-outline-secondary btn-sm mt-2" onclick="copyDiff()"><i class="bi bi-clipboard"></i> {% trans "复制" %}</button>';
    html += '</div>';
    document.getElementById('diffResultWrap').innerHTML = html;
    renderSideBySideDiff(data.text1, data.text2);
  });
});
// 首次渲染（如有结果）
document.addEventListener('DOMContentLoaded', function() {
  {% if diff %}
  renderSideBySideDiff(`{{ text1|escapejs }}`, `{{ text2|escapejs }}`);
  {% endif %}
});
</script>
{% endblock %} 